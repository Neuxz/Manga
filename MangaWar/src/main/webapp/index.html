<!DOCTYPE HTML>
<html>
<head>
<title>MangaLoader WebUI</title>
<meta charset="UTF-8" />
<script src="jquery-2.2.2.min.js"></script>
<link rel="stylesheet" href="style.css" />
<script>
	var md = {
		downloads : {},
	    showOnly : function(c, duration) {
	    	console.log("showOnly", c, duration);
	        if (c === "dl" || c == "jd") {
	            $("form#eingabe div").each(function(i, e) {
	                var $this = $(this);
	                if ($this.hasClass(c)) {
	                    $this.slideDown(duration);
	                } else {
	                    $this.slideUp(duration);
	                }
	            });
	        }
	    },
	    showSelected : function(duration) {
	    	console.log("showSelected", duration);
	        md.showOnly($("#selector > option:selected")[0].value, duration);
	    },
	    updateAll : function() {
	    	console.group("updateAll");
	    	$.each(md.downloads, (k,v) => md.update(k));
	    	console.groupEnd();
	    },
	    update : function(uuid) {
	    	console.log("update", uuid);
	    	var url = "download/progress?uuid=" + encodeURIComponent(uuid);
	    	$.getJSON(url, function(response) {
	    		md.downloads[uuid].current = response.progress;
	    		md.downloads[uuid].max = response.maxProgress; 
	    	});
	    },
	    createEntry : function(uuid) {
	    	console.log("createInterval", uuid);
	    	md.downloads[uuid] = {
	    		uuid : uuid,
	    		url : $("#url").text()
	    	};
	    }
    };
    $(function() {
        md.showSelected(0);
        var updateAllInterval = window.setInterval(md.updateAll, 5000);
        $("#selector").change(md.showSelected);
        $("#submit").click(function() {
            var queryArr = $("#eingabe > div > input")
			    .filter((i,elem) => $(elem).is(":visible"))
                .map((i,elem) => encodeURIComponent(elem.id) + "=" + encodeURIComponent(elem.value))
                .toArray();
            var query = "?" + queryArr.join("&");
            var url = "download/start" + query;
            $.get(url, md.createEntry);
        });
        $("#stopServer").click(function() {
            $.get("server/stop", function() {
				$("#content").slideUp();
				$("#closeNotice").slideDown();
				window.clearInterval(updateAllInterval);
			});
        });
    });
</script>
</head>
<body>
	<br />
	<div id="content">
		<div id="auswahl">
			<select id="selector">
				<option value="dl">Download</option>
				<option value="jd">per JDownloader</option>
			</select>
		</div>
		<form id="eingabe">
			<div class="dl jd">
				<label for="url">URL:&nbsp; </label>
				<input type="url" id="url" />
			</div>
			<div class="dl jd">
				<label for="proxy">Proxy-URL:&nbsp; </label>
				<input type="url" id="proxy" />
			</div>
			<div class="jd">
				<label for="folder">JD-Folder:&nbsp; </label>
				<input type="text" id="folder" />
			</div>
			<div class="dl jd">
				<label for="pattern">Kapitel:&nbsp; </label>
				<input type="text" id="pattern" />
			</div>
			<p id="buttons">
				<button type="button" id="submit">absenden</button>
				<button type="reset">zur&uuml;cksetzen</button>
				<button id="stopServer" type="button">Server stoppen</button>
			</p>
		</form>
	</div>
	<div id="closeNotice" style="display: none; padding: 1rem;">
		Server stopped, please close this Tab.
	</div>
	<div id="konachanlink">
		Bilder von <a href="http://konachan.net">konachan.net</a>
	</div>
</body>
</html>
